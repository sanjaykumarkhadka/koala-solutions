generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  AGENT
  COMPANY
  APPLICANT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL
  NEGOTIATION
  WON
  LOST
}

enum LeadSource {
  WEBSITE
  REFERRAL
  SOCIAL_MEDIA
  WALK_IN
  PHONE
  EMAIL
  OTHER
}

enum CaseStatus {
  DRAFT
  DOCUMENT_COLLECTION
  UNDER_REVIEW
  SUBMITTED
  PROCESSING
  ADDITIONAL_INFO
  APPROVED
  REJECTED
  COMPLETED
}

enum VisaType {
  WORK
  STUDENT
  TOURIST
  BUSINESS
  FAMILY
  PERMANENT_RESIDENCE
  CITIZENSHIP
  OTHER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum DocumentCategory {
  IDENTITY
  EDUCATION
  EMPLOYMENT
  FINANCIAL
  MEDICAL
  LEGAL
  TRAVEL
  OTHER
}

enum TimelineEventType {
  STATUS_CHANGE
  DOCUMENT_UPLOADED
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  NOTE_ADDED
  ASSIGNMENT_CHANGED
  APPLICATION_SUBMITTED
  INTERVIEW_SCHEDULED
  DECISION_MADE
  CUSTOM
}

enum JobStatus {
  DRAFT
  OPEN
  PAUSED
  CLOSED
  FILLED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERNSHIP
}

enum CandidateStatus {
  ACTIVE
  INACTIVE
  PLACED
  BLACKLISTED
}

enum ApplicationStatus {
  APPLIED
  SCREENING
  INTERVIEW
  OFFER
  HIRED
  REJECTED
  WITHDRAWN
}

enum ConversationType {
  CASE
  SUPPORT
  DIRECT
}

enum NotificationType {
  LEAD_ASSIGNED
  CASE_UPDATE
  DOCUMENT_UPLOADED
  DOCUMENT_REVIEWED
  MESSAGE_RECEIVED
  JOB_MATCH
  SYSTEM
}

// =============================================================================
// MODELS
// =============================================================================

model Tenant {
  id        String       @id @default(uuid())
  name      String
  slug      String       @unique
  domain    String?      @unique
  plan      Plan         @default(FREE)
  status    TenantStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations
  settings      TenantSettings?
  users         User[]
  leads         Lead[]
  cases         Case[]
  documents     Document[]
  companies     Company[]
  jobs          Job[]
  candidates    Candidate[]
  conversations Conversation[]
  notifications Notification[]

  @@map("tenants")
}

model TenantSettings {
  id           String   @id @default(uuid())
  tenantId     String   @unique
  logoUrl      String?
  primaryColor String   @default("#0ea5e9")
  timezone     String   @default("UTC")
  dateFormat   String   @default("YYYY-MM-DD")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_settings")
}

model User {
  id           String     @id @default(uuid())
  tenantId     String
  email        String
  passwordHash String
  firstName    String
  lastName     String
  role         UserRole   @default(APPLICANT)
  status       UserStatus @default(PENDING)
  avatarUrl    String?
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  tenant              Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedLeads       Lead[]          @relation("AssignedLeads")
  assignedCases       Case[]          @relation("AssignedCases")
  applicantCases      Case[]          @relation("CaseApplicant")
  createdCases        Case[]          @relation("CreatedCases")
  uploadedDocuments   Document[]      @relation("UploadedDocuments")
  reviewedDocuments   Document[]      @relation("ReviewedDocuments")
  timelineEvents      TimelineEvent[]
  createdJobs         Job[]
  candidate           Candidate?
  sentMessages        Message[]
  notifications       Notification[]
  conversationMembers ConversationMember[]

  @@unique([tenantId, email])
  @@map("users")
}

model Lead {
  id               String      @id @default(uuid())
  tenantId         String
  firstName        String
  lastName         String
  email            String
  phone            String?
  status           LeadStatus  @default(NEW)
  source           LeadSource  @default(OTHER)
  nationality      String?
  interestedVisa   String?
  notes            String?
  assignedToId     String?
  convertedToCaseId String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  // Relations
  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedTo   User?  @relation("AssignedLeads", fields: [assignedToId], references: [id])
  convertedCase Case? @relation("ConvertedFromLead")

  @@index([tenantId, status])
  @@index([tenantId, assignedToId])
  @@map("leads")
}

model Case {
  id                 String     @id @default(uuid())
  tenantId           String
  caseNumber         String
  applicantId        String
  createdById        String
  firstName          String
  lastName           String
  email              String
  phone              String?
  visaType           VisaType
  status             CaseStatus @default(DRAFT)
  nationality        String?
  destinationCountry String?
  startDate          DateTime?
  expectedEndDate    DateTime?
  actualEndDate      DateTime?
  assignedToId       String?
  leadId             String?    @unique
  notes              String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  // Relations
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  applicant     User            @relation("CaseApplicant", fields: [applicantId], references: [id])
  createdBy     User            @relation("CreatedCases", fields: [createdById], references: [id])
  assignedTo    User?           @relation("AssignedCases", fields: [assignedToId], references: [id])
  lead          Lead?           @relation("ConvertedFromLead", fields: [leadId], references: [id])
  documents     Document[]
  timeline      TimelineEvent[]
  conversations Conversation[]

  @@unique([tenantId, caseNumber])
  @@index([tenantId, status])
  @@index([tenantId, applicantId])
  @@map("cases")
}

model Document {
  id           String           @id @default(uuid())
  tenantId     String
  caseId       String
  name         String
  filename     String
  mimeType     String
  size         Int
  category     DocumentCategory
  status       DocumentStatus   @default(PENDING)
  storagePath  String
  uploadedById String
  reviewedById String?
  reviewNotes  String?
  expiresAt    DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  tenant     Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  case       Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  uploadedBy User   @relation("UploadedDocuments", fields: [uploadedById], references: [id])
  reviewedBy User?  @relation("ReviewedDocuments", fields: [reviewedById], references: [id])

  @@index([tenantId, caseId])
  @@map("documents")
}

model TimelineEvent {
  id          String            @id @default(uuid())
  tenantId    String
  caseId      String
  type        TimelineEventType
  title       String
  description String?
  metadata    Json?
  createdById String
  createdAt   DateTime          @default(now())

  // Relations
  case      Case @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdById], references: [id])

  @@index([caseId])
  @@map("timeline_events")
}

model Company {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  industry     String?
  website      String?
  contactEmail String
  contactPhone String?
  address      String?
  country      String
  logoUrl      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  jobs   Job[]

  @@index([tenantId])
  @@map("companies")
}

model Job {
  id              String    @id @default(uuid())
  tenantId        String
  companyId       String
  title           String
  description     String
  requirements    String[]
  location        String
  country         String
  salary          String?
  jobType         JobType
  status          JobStatus @default(DRAFT)
  visaSponsorship Boolean   @default(false)
  openPositions   Int       @default(1)
  filledPositions Int       @default(0)
  deadline        DateTime?
  createdById     String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company      Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdBy    User             @relation(fields: [createdById], references: [id])
  applications JobApplication[]

  @@index([tenantId, status])
  @@index([tenantId, companyId])
  @@map("jobs")
}

model Candidate {
  id                 String          @id @default(uuid())
  tenantId           String
  userId             String          @unique
  resumeUrl          String?
  skills             String[]
  experience         Int             @default(0)
  education          String?
  currentLocation    String?
  preferredLocations String[]
  expectedSalary     String?
  availableFrom      DateTime?
  status             CandidateStatus @default(ACTIVE)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Relations
  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  applications JobApplication[]

  @@index([tenantId, status])
  @@map("candidates")
}

model JobApplication {
  id          String            @id @default(uuid())
  jobId       String
  candidateId String
  status      ApplicationStatus @default(APPLIED)
  matchScore  Float?
  notes       String?
  appliedAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  // Relations
  job       Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  candidate Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  @@unique([jobId, candidateId])
  @@index([jobId, status])
  @@map("job_applications")
}

model Conversation {
  id           String           @id @default(uuid())
  tenantId     String
  type         ConversationType
  caseId       String?
  lastMessageAt DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  // Relations
  tenant   Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  case     Case?                @relation(fields: [caseId], references: [id])
  members  ConversationMember[]
  messages Message[]

  @@index([tenantId])
  @@map("conversations")
}

model ConversationMember {
  id             String   @id @default(uuid())
  conversationId String
  userId         String
  joinedAt       DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_members")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderId       String
  content        String
  readBy         String[]
  createdAt      DateTime @default(now())

  // Relations
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@index([conversationId, createdAt])
  @@map("messages")
}

model Notification {
  id        String           @id @default(uuid())
  tenantId  String
  userId    String
  type      NotificationType
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@map("notifications")
}
